                                 ┌──────────────────────────────┐
                                 │        FILE UPLOAD           │
                                 └──────────────┬───────────────┘
                                                ↓
                                 ┌────────────────────────────────────────────┐
                                 │           File Size ≤ MAX_SIZE ?           │
                                 └───────┬─────────────────────────┬──────────┘
                                         │NO                       │YES
                                         ↓                         ↓
                                       REJECT        ┌────────────────────────────────────┐
                                                     │       MIME & Binary Valid ?        │
                                                     └───────┬───────────────┬────────────┘
                                                             │NO             │YES
                                                             ↓               ↓
                                                           REJECT      ┌───────────────────────────────────┐
                                                                       │      Security Check Passed ?      │
                                                                       └───────┬────────────────┬──────────┘
                                                                               │NO              │YES
                                                                               ↓                ↓
                                                                            REJECT      ┌──────────────────────────────┐
                                                                                        │ Compute File Hash            │
                                                                                        └──────────────┬───────────────┘
                                                                                                       ↓
                                                                                        ┌────────────────────────────────────────────┐
                                                                                        │               Hash Exists ?                │
                                                                                        └───────┬─────────────────────────┬──────────┘
                                                                                                │YES                      │NO
                                                                                                ↓                         │
                                                                                           REUSE INGESTION                │      
                                                                                                                          │
                                                                                                                          │
                                                                                                                          │
                                                                                                                          │
                                                                                                                          ↓
                                                                                                   ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
                                                                                                   │                              Detect Actual Format                                                     │
                                                                                                   └────┬────────────────────────────────────┬─────────────────────────────┬───────────────────────────┬───┘
                                                                                                        │                                    │                             │                           │
                                                                                                        PDF                                HTML                            MD                         TXT
                                                                                                        ↓                                    ↓                             ↓                           ↓
                                                                                                    ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
                                                                                                         PDF PATH                         HTML PATH                              MARKDOWN PATH                            TXT PATH
                                                                                                    ────────┬────────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬───────
                                                                                                     ┌───────────────┐                    ┌────────────────────┐                 ┌──────────────────────┐            ┌───────────────────┐
                                                                                                     │ Parse PDF ?   │                    │   Valid DOM ?      │                 │      Parse AST ?     │            │  Detect Encoding  │
                                                                                                     └───┬─────┬─────┘                    └───┬──────────┬─────┘                 └───┬────────────┬─────┘            └────┬───────┬──────┘
                                                                                                         │NO   │YES                           │NO        │YES                        │NO          │YES                    │NO     │YES
                                                                                                         ↓     ↓                              ↓          ↓                           ↓            ↓                       ↓       ↓
                                                                                                     REJECT  ┌────────────────────────────┐ Repair DOM  Extract Main Logic      Fallback TXT   Parse Blocks           REJECT  Read Text
                                                                                                             │        Text Present        │                    
                                                                                                             └───┬───────┬─────────┬──────┘
                                                                                                                 │NO     │PARTIAL  │YES
                                                                                                                 ↓       ↓         ↓
                                                                                                             OCR PATH   Hybrid    Digital Text
                                                                                                                │        │         │
                                                                                                                ↓        ↓         ↓
                                                                                                             OCR Confidence ≥ THRESHOLD ?
                                                                                                                   │NO               │YES
                                                                                                                   ↓                 ↓
                                                                                                                Low Quality Flag   Clean Text
                                                                        ─────────────────────────────────────────────────────────────────────────────────────────────────────
                                                                                                           ↓ (ALL FORMATS MERGE HERE)
                                                                        ─────────────────────────────────────────────────────────────────────────────────────────────────────
                                                                                                        ┌──────────────────────────────┐
                                                                                                        │ Extract Logical Blocks       │
                                                                                                        │ (paragraphs, tables, code)   │
                                                                                                        └──────────────┬───────────────┘
                                                                                                                       ↓
                                                                                                        ┌────────────────────────────────┐
                                                                                                        │ Language Detection (per block) │
                                                                                                        └──────────────┬─────────────────┘
                                                                                                                       ↓
                                                                                                        ┌─────────────────────────────────────┐
                                                                                                        │      Supported Language ?           │
                                                                                                        └───────┬──────────────────┬──────────┘
                                                                                                                │NO                │YES
                                                                                                                ↓                  ↓
                                                                                                          Warn + Tag   ┌──────────────────────────────┐
                                                                                                                       │ Normalize (lang-aware)       │
                                                                                                                       └──────────────┬───────────────┘
                                                                                                                                      ↓
                                                                                                                        ┌──────────────────────────────┐
                                                                                                                        │       Quality Scoring        │
                                                                                                                        │  (OCR, noise, structure)     │
                                                                                                                        └──────────────┬───────────────┘
                                                                                                                                       ↓
                                                                                                                        ┌──────────────────────────────┐
                                                                                                                        │ Block Length > MAX_TOKENS ?  │
                                                                                                                        └───────┬───────────┬──────────┘
                                                                                                                                │NO         │YES
                                                                                                                                ↓           ↓
                                                                                                                          Single Chunk   Chunk Further
                                                                                                                                            ↓
                                                                                                                                        ┌──────────────────────────────┐
                                                                                                                                        │ Chunking Strategy            │
                                                                                                                                        │ (format + lang + block type) │
                                                                                                                                        └──────────────┬───────────────┘
                                                                                                                                                       ↓
                                                                                                                                        ┌──────────────────────────────┐
                                                                                                                                        │       Chunk Validation       │
                                                                                                                                        │    (empty? too noisy?)       │
                                                                                                                                        └───────┬───────────┬──────────┘
                                                                                                                                                │FAIL       │PASS
                                                                                                                                                ↓           ↓
                                                                                                                                          DROP CHUNK   ┌──────────────────────────────┐
                                                                                                                                                       │ Persist Chunks + Metadata    │
                                                                                                                                                       └──────────────┬───────────────┘
                                                                                                                                                                      ↓
                                                                                                                                                        ┌──────────────────────────────┐
                                                                                                                                                        │ Ready for Embedding / Index  │
                                                                                                                                                        └──────────────────────────────┘
